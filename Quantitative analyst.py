# -*- coding: utf-8 -*-
"""é‡åŒ–åˆ†æ.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1-nlTf7ZIwXVagXQ-Ud7nkaMnIGqCu2IJ
"""

# !pip install hmmlearn yfinance
import yfinance as yf
import pandas as pd
import numpy as np
import matplotlib
matplotlib.use('Agg')
import matplotlib.pyplot as plt
from hmmlearn.hmm import GaussianHMM
from datetime import datetime, timedelta
import os
import pytz
import pandas_market_calendars as mcal

# ==========================================
# 2. ç­–ç•¥åƒæ•¸ç¸½æ§ (Master Config)
# ==========================================
class Config:
    TICKERS = ["MSFT", "AAPL", "GOOGL", "NVDA", "TSLA", "TSM", "META", "AVGO", "ORCL", "AMZN", "MU", "AMD"]

    START_DATE = "2020-01-01"
    # yfinance end date is exclusive, so we add 1 day to include today
    END_DATE = (datetime.now() + timedelta(days=1)).strftime("%Y-%m-%d")

    HMM_COMPONENTS = 3
    SHORT_MA = 10
    LONG_MA_TREND = 200
    LONG_MA_SUPPORT = 50
    RSI_RESET = 55

    # MACD åƒæ•¸ (æ¨™æº–12,26,9)
    MACD_FAST = 12
    MACD_SLOW = 26
    MACD_SIGNAL = 9

    # æ–°å¢åœ–è¡¨ç¹ªè£½é–‹é—œ (None: ç¹ªè£½æ‰€æœ‰åœ–è¡¨; []: ä¸ç¹ªè£½ä»»ä½•åœ–è¡¨; ["MSFT", "AAPL"]: ç¹ªè£½æŒ‡å®šè‚¡ç¥¨åœ–è¡¨)
    TICKERS_TO_PLOT = [] # é è¨­ç‚º Noneï¼Œè¡¨ç¤ºç¹ªè£½æ‰€æœ‰åœ–è¡¨

# ==========================================
# 3. æ ¸å¿ƒæ•¸æ“šå¼•æ“ - åŠ å…¥ MACD äº¤å‰è¨Šè™Ÿ
# ==========================================
def get_data_and_indicators(ticker):
    print(f"ğŸ“¥ æ­£åœ¨ä¸‹è¼‰ {ticker} æ•¸æ“š...")
    raw_df = yf.download(ticker, start=Config.START_DATE, end=Config.END_DATE, progress=False)

    if raw_df.empty:
        print(f"âš ï¸ {ticker} ç„¡æ•¸æ“šï¼Œè·³éã€‚")
        return None

    df = pd.DataFrame(index=raw_df.index)

    if isinstance(raw_df.columns, pd.MultiIndex):
        df['Close'] = raw_df['Adj Close'][ticker] if 'Adj Close' in raw_df.columns.get_level_values(0) else raw_df['Close'][ticker]
        df['High'] = raw_df['High'][ticker]
        df['Low'] = raw_df['Low'][ticker]
        df['Open'] = raw_df['Open'][ticker]
    else:
        df['Close'] = raw_df['Adj Close'] if 'Adj Close' in raw_df.columns else raw_df['Close']
        df['High'] = raw_df['High']
        df['Low'] = raw_df['Low']
        df['Open'] = raw_df['Open']

    # ç§»å‹•å¹³å‡
    df['MA_10'] = df['Close'].rolling(window=Config.SHORT_MA).mean()
    df['MA_50'] = df['Close'].rolling(window=Config.LONG_MA_SUPPORT).mean()
    df['MA_200'] = df['Close'].rolling(window=Config.LONG_MA_TREND).mean()

    # RSI
    delta = df['Close'].diff()
    gain = (delta.where(delta > 0, 0)).ewm(alpha=1/14, adjust=False).mean()
    loss = (-delta.where(delta < 0, 0)).ewm(alpha=1/14, adjust=False).mean()
    rs = gain / loss
    df['RSI'] = 100 - (100 / (1 + rs))

    # MACD è¨ˆç®—
    ema_fast = df['Close'].ewm(span=Config.MACD_FAST, adjust=False).mean()
    ema_slow = df['Close'].ewm(span=Config.MACD_SLOW, adjust=False).mean()
    df['MACD'] = ema_fast - ema_slow
    df['MACD_Signal'] = df['MACD'].ewm(span=Config.MACD_SIGNAL, adjust=False).mean()
    df['MACD_Hist'] = df['MACD'] - df['MACD_Signal']

    # === å„ªåŒ–ï¼šæ–°å¢ MACD äº¤å‰è¨Šè™Ÿæ¬„ä½ ===
    df['MACD_Golden_Cross'] = (df['MACD'].shift(1) < df['MACD_Signal'].shift(1)) & (df['MACD'] > df['MACD_Signal'])
    df['MACD_Death_Cross'] = (df['MACD'].shift(1) > df['MACD_Signal'].shift(1)) & (df['MACD'] < df['MACD_Signal'])

    # HMM ç‰¹å¾µ
    df['Log_Ret'] = np.log(df['Close'] / df['Close'].shift(1))
    df['Range_Vol'] = (df['High'] - df['Low']) / df['Open']

    return df.dropna()

# ==========================================
# 4. HMM ç‹€æ…‹è­˜åˆ¥å¼•æ“
# ==========================================
def run_hmm(df):
    X = df[['Log_Ret', 'Range_Vol']].values
    model = GaussianHMM(n_components=Config.HMM_COMPONENTS, covariance_type="full", n_iter=1000, random_state=42)
    model.fit(X)
    hidden_states = model.predict(X)

    vol_means = [np.mean(X[hidden_states == i, 1]) for i in range(Config.HMM_COMPONENTS)]
    sorted_idx = np.argsort(vol_means)
    state_map = {old: new for new, old in enumerate(sorted_idx)}
    remapped_states = np.array([state_map[s] for s in hidden_states])

    df['HMM_State'] = remapped_states
    return df

# ==========================================
# 5. æˆ°æƒ…å„€è¡¨æ¿èˆ‡è¦–è¦ºåŒ– - å„ªåŒ– MACD é‚è¼¯ & æ¨™è¨˜äº¤å‰é»
# ==========================================
def plot_dashboard(df, ticker, should_plot=True):
    last_idx = df.index[-1]
    last_row = df.iloc[-1]

    hmm_colors = ['#2ca02c', '#ff7f0e', '#d62728']
    hmm_labels = ['Bull (Low Vol)', 'Neutral (Choppy)', 'Bear (High Vol)']
    current_state = int(last_row['HMM_State'])

    dist_to_ma10 = (last_row['Close'] - last_row['MA_10']) / last_row['MA_10'] * 100
    dist_to_ma50 = (last_row['Close'] - last_row['MA_50']) / last_row['MA_50'] * 100

    # æœ€æ–° MACD ç‹€æ…‹
    macd_above_signal = last_row['MACD'] > last_row['MACD_Signal']
    hist_positive = last_row['MACD_Hist'] > 0
    recent_golden = df['MACD_Golden_Cross'].iloc[-1]
    recent_death = df['MACD_Death_Cross'].iloc[-1]

    print("\n" + "="*70)
    print(f"ğŸ“Š {ticker} é‡åŒ–æˆ°æƒ…å®¤å ±å‘Š ({last_idx.date()})")
    print("="*70)
    print(f"1. å¸‚å ´å¾®çµæ§‹ (HMM):  {hmm_labels[current_state]}")
    print(f"2. ç›®å‰è‚¡åƒ¹:          ${last_row['Close']:.2f}")
    print(f"3. å‹•èƒ½æŒ‡æ¨™ (MA10):   ${last_row['MA_10']:.2f} (Gap: {dist_to_ma10:+.2f}%)")
    print(f"4. æ©Ÿæ§‹æˆæœ¬ (MA50):   ${last_row['MA_50']:.2f} (Gap: {dist_to_ma50:+.2f}%)")
    print(f"5. RSI (14):          {last_row['RSI']:.1f}")
    print(f"6. MACD ç‹€æ…‹:         MACD {last_row['MACD']:+.3f} | Signal {last_row['MACD_Signal']:+.3f} | Hist {last_row['MACD_Hist']:+.3f}")
    print(f"   â†’ MACD åœ¨ Signal ä¸Šæ–¹: {macd_above_signal} | Histogram æ­£å€¼: {hist_positive}")
    print("-" * 70)


    print("="*70)

    # ç¹ªåœ–ï¼šä¸‰å­åœ– (åƒ…åœ¨ should_plot ç‚º True æ™‚åŸ·è¡Œ)
    if should_plot:
        fig, (ax1, ax2, ax3) = plt.subplots(3, 1, figsize=(16, 14), sharex=True, gridspec_kw={'height_ratios': [4, 1, 1]})

        # Price + HMM + MAs
        for i in range(len(df)-1):
            state = int(df['HMM_State'].iloc[i])
            ax1.axvspan(df.index[i], df.index[i+1], color=hmm_colors[state], alpha=0.15)

        ax1.plot(df.index, df['Close'], color='black', lw=1.5, label='Price')
        ax1.plot(df.index, df['MA_10'], color='orange', lw=1.5, label='MA10')
        ax1.plot(df.index, df['MA_50'], color='blue', lw=2, label='MA50')
        ax1.plot(df.index, df['MA_200'], color='gray', lw=1, ls='--', label='MA200')

        # åŸæœ‰è¨Šè™Ÿ
        breakdown = df[(df['Close'] < df['MA_10']) & (df['Close'].shift(1) >= df['MA_10'].shift(1)) & (df['HMM_State'] > 0)]
        ax1.scatter(breakdown.index, breakdown['Close'], color='red', marker='v', s=80, label='Short Signal', zorder=5)

        reload = df[(df['Low'] <= df['MA_50']*1.02) & (df['Close'] > df['MA_200']) & (df['RSI'] < Config.RSI_RESET)]
        ax1.scatter(reload.index, reload['Low'], color='green', marker='^', s=100, label='Long Signal', zorder=5)

        ax1.set_title(f"{ticker} å¤šå› å­ç­–ç•¥å„€è¡¨æ¿ (HMM + MA + RSI + MACD å„ªåŒ–ç‰ˆ)", fontsize=14)
        ax1.legend(loc='upper left')
        ax1.grid(True, alpha=0.3)
        ax1.set_yscale('log')

        # RSI
        ax2.plot(df.index, df['RSI'], color='purple', lw=1.5)
        ax2.axhline(70, color='red', ls='--', alpha=0.6)
        ax2.axhline(30, color='green', ls='--', alpha=0.6)
        ax2.axhline(Config.RSI_RESET, color='blue', ls=':', label=f'Reset ({Config.RSI_RESET})')
        ax2.fill_between(df.index, df['RSI'], 70, where=(df['RSI'] >= 70), color='red', alpha=0.3)
        ax2.fill_between(df.index, df['RSI'], 30, where=(df['RSI'] <= 30), color='green', alpha=0.3)
        ax2.set_ylabel('RSI (14)')
        ax2.legend()
        ax2.grid(True, alpha=0.3)

        # MACD - æ–°å¢é‡‘å‰/æ­»å‰æ¨™è¨˜
        ax3.plot(df.index, df['MACD'], color='black', lw=1.2, label='MACD')
        ax3.plot(df.index, df['MACD_Signal'], color='red', lw=1.2, label='Signal')
        ax3.bar(df.index, df['MACD_Hist'], color=np.where(df['MACD_Hist'] > 0, 'green', 'red'), alpha=0.6, width=1, label='Histogram')
        ax3.axhline(0, color='gray', lw=0.8, ls='--')

        golden_dates = df[df['MACD_Golden_Cross']].index
        death_dates = df[df['MACD_Death_Cross']].index
        ax3.scatter(golden_dates, df.loc[golden_dates, 'MACD'], color='lime', marker='^', s=100, label='Golden Cross', zorder=5)
        ax3.scatter(death_dates, df.loc[death_dates, 'MACD'], color='magenta', marker='v', s=100, label='Death Cross', zorder=5)

        ax3.set_ylabel('MACD')
        ax3.legend()
        ax3.grid(True, alpha=0.3)

        plt.tight_layout()
        plt.show()

    return {
        'Ticker': ticker,
        'Last Close': f"${last_row['Close']:.2f}",
        'HMM State': hmm_labels[current_state],
        'MA10 Gap': f"{dist_to_ma10:+.2f}%",
        'MA50 Gap': f"{dist_to_ma50:+.2f}%",
        'RSI': f"{last_row['RSI']:.1f}",
        'MACD > Signal': macd_above_signal,
        'MACD Hist > 0': hist_positive

    }

# ==========================================
# 6. æ­·å²æ•¸æ“šèˆ‡æ’ç¨‹ç®¡ç† (New Features)
# ==========================================
def save_daily_snapshot(df):
    """
    ä¿å­˜æ¯æ—¥åˆ†æå¿«ç…§åˆ° CSV
    1. å¢åŠ  Date æ¬„ä½ (YYYY-MM-DD)
    2. è¿½åŠ åˆ° history_data.csv
    3. é¿å…é‡è¤‡å¯«å…¥åŒä¸€å¤©çš„æ•¸æ“š
    """
    file_path = "history_data.csv"
    today_str = datetime.now().strftime("%Y-%m-%d")
    
    # å¢åŠ  Date æ¬„ä½
    df_to_save = df.copy()
    df_to_save['Date'] = today_str
    
    # æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨
    if os.path.exists(file_path):
        try:
            existing_df = pd.read_csv(file_path)
            # æª¢æŸ¥æ˜¯å¦å·²æœ‰ä»Šæ—¥æ•¸æ“š
            if not existing_df[existing_df['Date'] == today_str].empty:
                print(f"âš ï¸ {today_str} çš„æ•¸æ“šå·²å­˜åœ¨ï¼Œå°‡è¦†è“‹ä»Šæ—¥æ•¸æ“š...")
                # å‰”é™¤ä»Šæ—¥èˆŠæ•¸æ“šï¼Œä¿ç•™å…¶ä»–æ—¥æœŸçš„
                existing_df = existing_df[existing_df['Date'] != today_str]
                
            # åˆä½µæ•¸æ“š
            final_df = pd.concat([existing_df, df_to_save], ignore_index=True)
        except Exception as e:
            print(f"âŒ è®€å–æ­·å²æª”æ¡ˆå¤±æ•—: {e}ï¼Œå°‡å»ºç«‹æ–°æª”æ¡ˆã€‚")
            final_df = df_to_save
    else:
        final_df = df_to_save
        
    # å¯«å…¥ CSV
    final_df.to_csv(file_path, index=False)
    print(f"âœ… å·²ä¿å­˜ {today_str} çš„åˆ†æçµæœåˆ° {file_path}")

def get_stock_history(ticker):
    """
    è®€å–ç‰¹å®šè‚¡ç¥¨çš„æ­·å²åˆ†ææ•¸æ“š
    """
    file_path = "history_data.csv"
    if not os.path.exists(file_path):
        print(f"âš ï¸ æ‰¾ä¸åˆ°æ­·å²æª”æ¡ˆ {file_path}")
        return None
        
    df = pd.read_csv(file_path)
    ticker_df = df[df['Ticker'] == ticker].sort_values(by='Date')
    return ticker_df

def should_run_now():
    """
    æª¢æŸ¥æ˜¯å¦æ‡‰è©²åŸ·è¡Œè…³æœ¬ï¼š
    1. ä»Šå¤©æ˜¯å¦ç‚º NYSE äº¤æ˜“æ—¥
    2. ç¾åœ¨æ™‚é–“æ˜¯å¦è¶…éæ”¶ç›¤æ™‚é–“ (16:15 ET)
    """
    # è¨­å®šæ™‚å€
    eastern = pytz.timezone('US/Eastern')
    now_et = datetime.now(eastern)
    
    print(f"ğŸ•’ ç•¶å‰ç¾æ±æ™‚é–“: {now_et.strftime('%Y-%m-%d %H:%M:%S')}")

    # 1. æª¢æŸ¥æ˜¯å¦ç‚ºäº¤æ˜“æ—¥
    nyse = mcal.get_calendar('NYSE')
    schedule = nyse.schedule(start_date=now_et.date(), end_date=now_et.date())
    
    if schedule.empty:
        print("â¸ï¸ ä»Šå¤©ä¸æ˜¯ NYSE äº¤æ˜“æ—¥ï¼Œè·³éåŸ·è¡Œã€‚")
        return False
        
    print("âœ… ä»Šå¤©æ˜¯æœ‰æ•ˆäº¤æ˜“æ—¥ã€‚")
    
    # 2. æª¢æŸ¥æ™‚é–“ (16:15 å¾Œ)
    market_close = schedule.iloc[0]['market_close'].to_pydatetime().replace(tzinfo=eastern)
    # åŠ ä¸Š 15 åˆ†é˜ç·©è¡ï¼Œç¢ºä¿æ•¸æ“šå·²çµç®—
    target_time = market_close.replace(hour=16, minute=15, second=0, microsecond=0)
    
    if now_et.time() < target_time.time():
        print(f"â³ å°šæœªæ”¶ç›¤ (ç›®æ¨™æ™‚é–“ {target_time.time()})ï¼Œç¨å¾Œå†è©¦ã€‚")
        return False
        
    print("ğŸš€ æ™‚é–“ç¬¦åˆï¼Œæº–å‚™åŸ·è¡Œåˆ†æ...")
    return True

# ==========================================
# 7. ä¸»ç¨‹å¼åŸ·è¡Œå…¥å£
# ==========================================

if __name__ == "__main__":
    if should_run_now():
        all_summaries = []
        print(f"\nğŸš€ é–‹å§‹æ‰¹é‡åˆ†æ {len(Config.TICKERS)} å€‹æ¨™çš„ï¼š{Config.TICKERS}\n")

        for ticker in Config.TICKERS:
            data = get_data_and_indicators(ticker)
            if data is not None and len(data) > 200:
                data_analyzed = run_hmm(data)

                # æ ¹æ“šé…ç½®æ±ºå®šæ˜¯å¦ç¹ªè£½åœ–è¡¨
                should_plot_for_ticker = (Config.TICKERS_TO_PLOT is None) or (ticker in Config.TICKERS_TO_PLOT)
                
                # æ³¨æ„ï¼šå¦‚æœæ˜¯åœ¨è‡ªå‹•åŒ–ç’°å¢ƒè·‘ï¼Œå¯ä»¥æŠŠ plot_dashboard çš„ should_plot å¼·åˆ¶è¨­ç‚º False ä»¥ç¯€çœè³‡æº
                # summary = plot_dashboard(data_analyzed, ticker, should_plot=should_plot_for_ticker)
                
                # ç‚ºäº†é¿å… GitHub Action å ±éŒ¯ï¼Œé€™è£¡é è¨­ä¿ç•™åŸæœ‰é‚è¼¯ï¼Œä½†å»ºè­°åœ¨ headless ç’°å¢ƒè¨­ç‚º False
                summary = plot_dashboard(data_analyzed, ticker, should_plot=should_plot_for_ticker)
                
                all_summaries.append(summary)
            else:
                print(f"âŒ {ticker} æ•¸æ“šä¸è¶³ï¼Œè·³éåˆ†æã€‚\n")

        # ç¶œåˆå ±å‘Šè¡¨æ ¼
        if all_summaries:
            summary_df = pd.DataFrame(all_summaries)
            print("\n" + "="*70)
            print("ğŸ“Š æ‰€æœ‰æ¨™çš„é‡åŒ–æˆ°æƒ…å®¤ç¶œåˆå ±å‘Š")
            print("="*70)
            
            # å…¼å®¹é Notebook ç’°å¢ƒ
            try:
                from IPython.display import display
                display(summary_df)
            except ImportError:
                print(summary_df.to_string())

            # ä¿å­˜æ­·å²æ•¸æ“š
            save_daily_snapshot(summary_df)
            
        else:
            print("\nç„¡æ•¸æ“šå¯ä¾›ç”Ÿæˆç¶œåˆå ±å‘Šã€‚")
    else:
        print("ğŸ’¤ æ¢ä»¶ä¸ç¬¦ï¼Œç¨‹å¼çµæŸã€‚")